<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, viewport-fit=cover" />
  <title>Kynar / Product Detail</title>
  <link rel="stylesheet" href="styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>

  <header class="app-header">
    <div class="header-inner" style="
      width: 100%; max-width: 1200px; margin: 0 auto; 
      display: grid; grid-template-columns: 44px 1fr 44px; align-items: center;
    ">
      <a href="shop.html" class="header-btn">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
      </a>
      <div style="display: flex; justify-content: center;">
         <span style="font-family: var(--font-display); font-weight: 800; letter-spacing: 0.1em; text-transform: uppercase;">Product Detail</span>
      </div>
      <button class="header-btn" onclick="toggleCart()">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"></path><line x1="3" y1="6" x2="21" y2="6"></line></svg>
      </button>
    </div>
  </header>

  <main class="product-container" style="min-height: 80vh;">
    
    <div class="product-stage">
       <div class="stage-visual" id="p-bg">
          <div id="p-icon" style="font-size: 5rem; animation: floatIcon 3s ease-in-out infinite;">ðŸ“¦</div>
       </div>
    </div>

    <div class="product-intel" id="desktop-wrapper">
      
      <div class="intel-header">
        <span class="status-chip" id="p-tag" style="margin-bottom: 0.5rem; display: inline-flex;">LOADING...</span>
        <h1 class="intel-title" id="p-title">Loading System...</h1>
        <div class="intel-price" id="p-price">--</div>
        <p class="intel-desc" id="p-desc">Fetching asset data from secure vault...</p>
      </div>

      <div class="spec-stack">
        <details class="spec-drawer" open>
          <summary class="spec-trigger">
            <span>Description</span>
            <svg class="chevron" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"></polyline></svg>
          </summary>
          <div class="spec-content">
            <p id="p-long-desc" style="font-size: 0.9rem; line-height: 1.6; color: var(--ink-muted);">
                </p>
          </div>
        </details>

        <details class="spec-drawer">
          <summary class="spec-trigger">
             <span>File Specs</span>
             <svg class="chevron" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"></polyline></svg>
          </summary>
          <div class="spec-content">
             <div class="tech-bit">
                <span class="bit-label">Format</span>
                <span class="bit-val">PDF / Digital</span>
             </div>
             <div class="tech-bit">
                <span class="bit-label">Delivery</span>
                <span class="bit-val">Instant Secure Download</span>
             </div>
          </div>
        </details>
      </div>

    </div>

  </main>

  <div class="sticky-action-bar">
    <div class="action-price">
      <span style="font-size: 0.7rem; color: var(--ink-muted); text-transform: uppercase; font-weight: 700;">Total</span>
      <span style="font-size: 1.1rem; font-weight: 800; color: var(--ink-display);" id="p-price-sticky">--</span>
    </div>
    <button class="action-btn" id="main-action-btn">Initialize</button>
  </div>

  <div id="interface-overlay"></div>

  <aside id="nav-drawer" class="drawer-panel drawer-left">
      <div class="drawer-header">
          <span class="drawer-title">Menu</span>
          <button class="close-btn" onclick="toggleNav()">âœ•</button>
      </div>
      <nav class="drawer-content">
          <a href="shop.html" class="drawer-link">Marketplace</a>
          <a href="library.html" class="drawer-link">Manuals</a>
          <a href="newsletter.html" class="drawer-link">The Network</a>
          <a href="account.html" class="drawer-link">Member Vault</a>
      </nav>
  </aside>

  <aside id="cart-drawer" class="drawer-panel drawer-right">
      <div class="drawer-header">
          <span class="drawer-title">Cart</span>
          <button class="close-btn" onclick="toggleCart()">âœ•</button>
      </div>
      <div class="drawer-content"></div> <div class="drawer-footer">
          <div class="cart-total-row">
              <span>Subtotal</span>
              <span>Â£0.00</span>
          </div>
          <button class="dock-btn" onclick="window.location.href='checkout.html'" style="width: 100%; justify-content: center; margin-top: 1rem;">
              Secure Checkout
          </button>
      </div>
  </aside>

  <script src="core.js"></script>
  <script src="cart.js"></script>
  
  <script type="module">
    import { supabase } from './supabase-config.js';
    import './vault.js'; // Imports the downloadProduct function

    // 1. HELPER: Map Categories to Visuals (Since DB doesn't store colors yet)
    function getVisuals(category) {
        const map = {
            'systems': { icon: 'âš¡', bg: 'var(--grad-gold)' },
            'creative': { icon: 'ðŸŽ¨', bg: 'var(--bg-canvas)' },
            'business': { icon: 'ðŸš€', bg: 'linear-gradient(135deg, #1e3c72 0%, #2a5298 100%)' },
            'ai': { icon: 'ðŸ¤–', bg: '#e0f2f1' },
            'education': { icon: 'ðŸ“…', bg: '#fff3e0' }
        };
        return map[category] || { icon: 'ðŸ“¦', bg: '#f5f5f5' };
    }

    // 2. FETCH LOGIC
    document.addEventListener('DOMContentLoaded', async () => {
      const params = new URLSearchParams(window.location.search);
      const id = params.get('id');

      if (!id) {
        document.getElementById('p-title').innerText = "System Error: ID Missing";
        return;
      }

      // Supabase Query
      const { data: product, error } = await supabase
        .from('products')
        .select('*')
        .eq('id', id)
        .single();

      if (error || !product) {
        document.getElementById('p-title').innerText = "System Not Found";
        document.getElementById('p-desc').innerText = "This asset may have been archived.";
        return;
      }

      // 3. INJECT DATA
      const visuals = getVisuals(product.category);
      const isFree = product.price === 0;
      const displayPrice = isFree ? "Free" : `Â£${Number(product.price).toFixed(2)}`;

      document.getElementById('p-title').innerText = product.title;
      document.getElementById('p-price').innerText = displayPrice;
      document.getElementById('p-price-sticky').innerText = displayPrice;
      document.getElementById('p-desc').innerText = product.description;
      document.getElementById('p-long-desc').innerText = product.description; // Duplicate for now
      document.getElementById('p-tag').innerText = product.category ? product.category.toUpperCase() : "DIGITAL ASSET";
      
      // Visuals
      document.getElementById('p-icon').innerText = visuals.icon;
      document.getElementById('p-bg').style.background = visuals.bg;

      // 4. BUTTON LOGIC (Free = Download, Paid = Cart)
      const btn = document.getElementById('main-action-btn');
      
      if (isFree) {
        btn.innerText = "Download Securely";
        btn.style.background = "var(--ink-display)";
        btn.onclick = () => {
             // Uses the global download function from vault.js
             if(window.downloadProduct) window.downloadProduct(product.file_path);
             else alert("Vault System Loading...");
        };
      } else {
        btn.innerText = "Add to Cart";
        btn.onclick = () => {
            if (window.KynarCart) {
                window.KynarCart.add({
                    id: String(product.id),
                    title: product.title,
                    price: product.price,
                    meta: product.category,
                    icon: visuals.icon,
                    bg: visuals.bg
                });
            }
        };
      }

      // 5. Inject Desktop Button (Clone logic)
      if(window.innerWidth > 800) {
          const desktopBtn = btn.cloneNode(true);
          desktopBtn.style.marginTop = '2rem';
          desktopBtn.style.width = '100%';
          // Re-attach listener because cloneNode doesn't copy listeners
          desktopBtn.onclick = btn.onclick; 
          document.querySelector('.product-intel').appendChild(desktopBtn);
      }

    });
  </script>

  <script>
    const overlay = document.getElementById('interface-overlay');
    const navDrawer = document.getElementById('nav-drawer');
    const cartDrawer = document.getElementById('cart-drawer');

    window.toggleNav = function() {
      const isActive = navDrawer.classList.contains('active');
      closeAllDrawers();
      if (!isActive) {
        navDrawer.classList.add('active');
        overlay.classList.add('active');
        document.body.style.overflow = 'hidden'; 
      }
    };

    window.toggleCart = function() {
      const isActive = cartDrawer.classList.contains('active');
      closeAllDrawers();
      if (!isActive) {
        cartDrawer.classList.add('active');
        overlay.classList.add('active');
        document.body.style.overflow = 'hidden';
      }
    };

    window.closeAllDrawers = function() {
      if(navDrawer) navDrawer.classList.remove('active');
      if(cartDrawer) cartDrawer.classList.remove('active');
      if(overlay) overlay.classList.remove('active');
      document.body.style.overflow = ''; 
    };

    if(overlay) overlay.addEventListener('click', closeAllDrawers);
  </script>

</body>
</html>
